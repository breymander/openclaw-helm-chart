name: Release Helm Chart

on:
  push:
    branches:
      - main
      - master
      - dev
    paths:
      - 'Chart.yaml'
      - 'values.yaml'
      - 'templates/**'
      - '.github/workflows/release-chart.yml'
      - '.helmignore'
  workflow_dispatch:
    inputs:
      dev_release:
        description: 'Force dev-style release (version suffix -dev, prerelease)'
        required: false
        default: "false"
        type: boolean

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: Set is_dev
        id: set-env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/dev" ] || [ "${{ github.event.inputs.dev_release }}" = "true" ]; then
            echo "is_dev=true" >> $GITHUB_OUTPUT
          else
            echo "is_dev=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Package chart
        id: package
        run: |
          CHART_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}' | tr -d '"')
          CHART_NAME=$(grep '^name:' Chart.yaml | awk '{print $2}' | tr -d '"')
          
          if [ "${{ steps.set-env.outputs.is_dev }}" = "true" ]; then
            PACKAGE_VERSION="${CHART_VERSION}-dev"
            helm package . --version "${PACKAGE_VERSION}" --destination /tmp
          else
            PACKAGE_VERSION="${CHART_VERSION}"
            helm package . --destination /tmp
          fi
          
          PACKAGE_FILE="${CHART_NAME}-${PACKAGE_VERSION}.tgz"
          echo "package_file=${PACKAGE_FILE}" >> $GITHUB_OUTPUT
          echo "chart_version=${PACKAGE_VERSION}" >> $GITHUB_OUTPUT
          echo "chart_name=${CHART_NAME}" >> $GITHUB_OUTPUT
          echo "is_dev=${{ steps.set-env.outputs.is_dev }}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: /tmp/${{ steps.package.outputs.package_file }}
          tag_name: openclaw-${{ steps.package.outputs.chart_version }}
          name: ${{ steps.package.outputs.is_dev == 'true' && format('Dev release {0}', steps.package.outputs.chart_version) || format('Release {0}', steps.package.outputs.chart_version) }}
          body: |
            ${{ steps.package.outputs.is_dev == 'true' && '**Dev build** â€“ use for testing only.' || '' }}
            Helm chart release for version ${{ steps.package.outputs.chart_version }}
            
            **Installation:**
            ```bash
            helm repo add openclaw https://breymander.github.io/openclaw-helm-chart
            helm repo update
            helm install my-openclaw openclaw/openclaw${{ steps.package.outputs.is_dev == 'true' && format(' --version {0}', steps.package.outputs.chart_version) || '' }}
            ```
          draft: false
          prerelease: ${{ steps.set-env.outputs.is_dev }}
          replace: ${{ steps.set-env.outputs.is_dev }}

      - name: Update index.yaml and index.html
        env:
          GH_REPO: breymander/openclaw-helm-chart
          CHART_NAME: ${{ steps.package.outputs.chart_name }}
          CURRENT_VERSION: ${{ steps.package.outputs.chart_version }}
          CURRENT_PACKAGE: ${{ steps.package.outputs.package_file }}
          BASE_URL: https://github.com/breymander/openclaw-helm-chart/releases/download
        run: |
          set -e
          ENTRIES_FILE="/tmp/entries.jsonl"
          : > "${ENTRIES_FILE}"
          
          # Collect .tgz asset metadata from all releases via API (no downloads)
          page=1
          while true; do
            resp=$(curl -sS -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${GH_REPO}/releases?per_page=100&page=${page}")
            count=$(echo "${resp}" | jq 'length')
            [ "${count}" -eq 0 ] && break
            echo "${resp}" | jq -r -c --arg chart "${CHART_NAME}" '.[] | select(.draft == false) | . as $rel | .assets[] | select(.name | endswith(".tgz")) | {version: (.name | sub("\\.tgz$"; "") | sub("^" + $chart + "-"; "")), url: .browser_download_url, created: $rel.published_at}' >> "${ENTRIES_FILE}"
            [ "${count}" -lt 100 ] && break
            page=$((page + 1))
          done
          
          # Add current build (API may be briefly stale)
          echo "{\"version\":\"${CURRENT_VERSION}\",\"url\":\"${BASE_URL}/openclaw-${CURRENT_VERSION}/${CURRENT_PACKAGE}\",\"created\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" >> "${ENTRIES_FILE}"
          
          # Build index.yaml from metadata (sort by version, dedupe) with full static metadata per entry
          {
            echo "apiVersion: v1"
            echo "entries:"
            echo "  ${CHART_NAME}:"
            jq -r -n '[inputs] | sort_by(.version) | unique_by(.version) | .[] | @json' < "${ENTRIES_FILE}" | while read -r line; do
              version=$(echo "${line}" | jq -r '.version')
              url=$(echo "${line}" | jq -r '.url')
              created=$(echo "${line}" | jq -r 'if .created then .created else (now | strftime("%Y-%m-%dT%H:%M:%SZ")) end')
              cat << ENTRY
  - apiVersion: v2
    appVersion: latest
    created: "${created}"
    description: A Helm chart for OpenClaw - an open-source personal AI assistant
    home: https://github.com/breymander/openclaw-helm-chart
    keywords:
    - openclaw
    - ai
    - assistant
    - claude
    maintainers:
    - name: OpenClaw Community
    name: ${CHART_NAME}
    sources:
    - https://github.com/breymander/openclaw-helm-chart
    - https://github.com/openclaw/openclaw
    type: application
    urls:
    - "${url}"
    version: "${version}"
ENTRY
            done
            echo "generated: \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\""
          } > /tmp/index.yaml
          
          if ! grep -q "releases/download" /tmp/index.yaml; then
            echo "ERROR: No release URLs in index.yaml"
            cat /tmp/index.yaml
            exit 1
          fi
          
          # Checkout gh-pages and update index
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          git checkout gh-pages 2>/dev/null || git checkout -b gh-pages
          mkdir -p docs
          cp /tmp/index.yaml docs/
          
          touch .nojekyll
          
          git add -f docs/index.yaml
          [ -f docs/index.html ] && git add -f docs/index.html
          git add .nojekyll
          git commit -m "Update index.yaml from releases [skip ci]" || true
          git push origin gh-pages || true

      - name: Summary
        run: |
          if [ "${{ steps.package.outputs.is_dev }}" = "true" ]; then
            echo "## Dev Chart Released ðŸ§ª" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The Helm chart has been packaged and released as **${{ steps.package.outputs.chart_version }}** (prerelease)." >> $GITHUB_STEP_SUMMARY
          else
            echo "## Chart Released Successfully ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The Helm chart has been packaged and released." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Installation:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "helm repo add openclaw https://breymander.github.io/openclaw-helm-chart" >> $GITHUB_STEP_SUMMARY
          echo "helm repo update" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.package.outputs.is_dev }}" = "true" ]; then
            echo "helm install my-openclaw openclaw/openclaw --version ${{ steps.package.outputs.chart_version }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "helm install my-openclaw openclaw/openclaw" >> $GITHUB_STEP_SUMMARY
          fi
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
