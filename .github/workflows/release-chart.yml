name: Release Helm Chart

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'Chart.yaml'
      - 'values.yaml'
      - 'templates/**'
      - '.github/workflows/release-chart.yml'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Package Helm chart
        run: |
          mkdir -p docs
          helm package . --destination docs

      - name: Generate index
        run: |
          # Generate index, merging with existing if it exists (for multiple chart versions)
          if [ -f docs/index.yaml ]; then
            helm repo index docs --url https://breymander.github.io/openclaw-helm-chart --merge docs/index.yaml
          else
            helm repo index docs --url https://breymander.github.io/openclaw-helm-chart
          fi

      - name: Check for changes
        id: check
        run: |
          if [ -n "$(git status --porcelain docs/)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check.outputs.changed == 'true'
        run: |
          git add docs/
          git commit -m "chore: update Helm chart package and index [skip ci]"
          git push

      - name: Summary
        if: steps.check.outputs.changed == 'true'
        run: |
          echo "## Chart Released Successfully ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Helm chart has been packaged and the repository index has been updated." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files updated:**" >> $GITHUB_STEP_SUMMARY
          git diff --name-only HEAD~1 docs/ | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY

      - name: No changes
        if: steps.check.outputs.changed == 'false'
        run: |
          echo "## No Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "Chart package and index are already up to date." >> $GITHUB_STEP_SUMMARY
